# 流式输出

默认情况下，方舟 API 会在生成全部内容后，再通过单次 HTTP 响应返回结果。如果输出长内容，等待时间会较长。流式响应模式下，模型会持续发送已生成的数据片段，你可实时看到中间输出过程内容，方便立即开始处理或展示部分结果。

## 效果与优势

| 预览 | 优势 |
| --- | --- |
| ![流式输出演示](../assets/images/streaming_demo.gif) | - 改善等待体验：无需等待完整内容生成完毕，可立即处理过程内容。<br>- 实时过程反馈：多轮交互场景，实时了解任务当前的处理阶段。<br>- 更高的容错性：中途出错，也能获取到已生成内容，避免非流式输出失败无返回的情况。<br>- 简化超时管理：保持客户端与服务端的连接状态，避免复杂任务耗时过长而连接超时。 |

## 使用说明

### 示例代码

**Curl**

```Bash
curl https://ark.cn-beijing.volces.com/api/v3/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ARK_API_KEY" \
  -d '{
    "model": "doubao-seed-1-6-251015",
    "messages": [
      {
        "role": "user",
        "content": "常见的十字花科植物有哪些？"
      }
    ],
    "stream": true
  }'
```

> - 按需替换 Model ID，查询 Model ID 请参见[模型列表](../模型介绍/模型列表.md)。
> - 替换 <ENDPOINT_ID> 为你的推理接入点ID，获取 ID 见[获取 Endpoint ID（创建自定义推理接入点）](../控制台功能/在线推理/创建推理接入点%20Endpoint.md)。
> - 根据网络替换 base url：The base URL for model invocation

**Python**

```Python
import os
# Install SDK: pip install 'volcengine-python-sdk[ark]'
from volcenginesdkarkruntime import Ark

# 初始化Ark客户端
client = Ark(
    # The base URL for model invocation
    base_url="https://ark.cn-beijing.volces.com/api/v3",
    # Get API Key：https://console.volcengine.com/ark/region:ark+cn-beijing/apikey
    api_key=os.getenv('ARK_API_KEY'),
)

completion = client.chat.completions.create(
    # Replace with Model ID
    model = "doubao-seed-1-6-251015",
    messages=[
        {"role": "user", "content": "常见的十字花科植物有哪些？"},
    ],
    stream=True,
)

with completion:  # 确保在代码块执行完毕后自动关闭连接，避免链接泄露
    for chunk in completion:
        if chunk.choices[0].delta.content is not None:
            print(chunk.choices[0].delta.content, end="")
```

> **说明**
> 
> `with completion`：当 with 代码块内出现异常时，会自动调用对象的 exit() 方法进行清理工作。当设置了 max_tokens 等中断条件时，可避免 socket 层数据载满最终程序卡住。

**Go**

```Go
package main

import (
    "context"
    "fmt"
    "os"

    "github.com/volcengine/volcengine-go-sdk/service/arkruntime"
    "github.com/volcengine/volcengine-go-sdk/service/arkruntime/model"
    "github.com/volcengine/volcengine-go-sdk/volcengine"
)

func main() {
    client := arkruntime.NewClientWithApiKey(
        os.Getenv("ARK_API_KEY"),
        // The base URL for model invocation
        arkruntime.WithBaseUrl("https://ark.cn-beijing.volces.com/api/v3"),
    )

    ctx := context.Background()

    fmt.Println("----- standard request -----")
    req := model.CreateChatCompletionRequest{
        // Replace with Model ID
        Model: "doubao-seed-1-6-251015",
        Messages: []*model.ChatCompletionMessage{
            {
                Role: model.ChatMessageRoleUser,
                Content: &model.ChatCompletionMessageContent{
                    StringValue: volcengine.String("常见的十字花科植物有哪些？"),
                },
            },
        },
        Stream: volcengine.Bool(true),
    }

    // 注意，此处区别非流式调用，应调用 CreateChatCompletionStream 方法
    resp, err := client.CreateChatCompletionStream(ctx, req)
    if err != nil {
        fmt.Printf("standard chat error: %v", err)
        return
    }
    defer resp.Close()

    for {
        chunk, err := resp.Recv()
        if err != nil {
            fmt.Printf("stream error: %v", err)
            break
        }
        fmt.Print(chunk.Choices[0].Delta.Content)
    }
    fmt.Println()
}
```

**Java**

```Java
package com.volcengine.ark.runtime;

import com.volcengine.ark.runtime.model.completion.chat.ChatCompletionRequest;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessage;
import com.volcengine.ark.runtime.model.completion.chat.ChatMessageRole;
import com.volcengine.ark.runtime.service.ArkService;
import java.util.ArrayList;
import java.util.List;

public class ChatCompletionsExample {
    public static void main(String[] args) {
        String apiKey = System.getenv("ARK_API_KEY");
        // The base URL for model invocation
        ArkService service = ArkService.builder().apiKey(apiKey).baseUrl("https://ark.cn-beijing.volces.com/api/v3").build();

        final List<ChatMessage> messages = new ArrayList<>();
        final ChatMessage userMessage = ChatMessage.builder().role(ChatMessageRole.USER).content("常见的十字花科植物有哪些？").build();
        messages.add(userMessage);

        ChatCompletionRequest chatCompletionRequest = ChatCompletionRequest.builder()
                .model("doubao-seed-1-6-251015")  //Replace with Model ID
                .messages(messages)
                .stream(true)
                .thinking(new ChatCompletionRequest.ChatCompletionRequestThinking("disabled"))
                .build();

        service.streamChatCompletion(chatCompletionRequest)
                .doOnError(Throwable::printStackTrace)  // 处理错误
                .blockingForEach(response -> {
                    if (response.getChoices() != null && !response.getChoices().isEmpty()) {
                        String content = String.valueOf(response.getChoices().get(0).getMessage().getContent());
                        if (content != null) {
                            System.out.print(content);  // 注意用print而非println，保持内容连续
                        }
                    }
                });

        // shutdown service
        service.shutdownExecutor();
    }
}
```

**OpenAI SDK**

```Python
import os
from openai import OpenAI

client = OpenAI(
    # 从环境变量中读取方舟API Key
    api_key=os.environ.get("ARK_API_KEY"),
    base_url="https://ark.cn-beijing.volces.com/api/v3",
    # 深度思考耗时更长，避免链接超时导致失败，请设置更大的超时限制，推荐为1800 秒及以上
    timeout=1800,
)

completion = client.chat.completions.create(
    # Replace with Model ID
    model = "doubao-seed-1-6-251015",
    messages=[
        {"role": "user", "content": "深度思考模型与非深度思考模型区别"},
    ],
    stream=True,
)

reasoning_content = ""
content = ""

with completion:
    for chunk in completion:
        if hasattr(chunk.choices[0].delta, 'reasoning_content') and chunk.choices[0].delta.reasoning_content:
            reasoning_content += chunk.choices[0].delta.reasoning_content
            print(chunk.choices[0].delta.reasoning_content, end="")
        else:
            content += chunk.choices[0].delta.content
            print(chunk.choices[0].delta.content, end="")
```

[Responses API](../API%20参考/Responses%20API/Responses%20API%20参数说明.md)示例代码请参见[流式输出](../使用%20Responses%20API/文本生成.md#流式输出)。

### 启用流式

通过配置 stream 为 `true`，来启用流式输出。

### 返回处理

流式响应基于 Server-Sent Events (SSE) 协议实现，其核心是服务端通过 HTTP 长连接持续向客户端推送数据片段。每个数据片段（Chunk）由字段行组成。包括模型深度思考内容片段、回复内容片段、工具调用片段等。流式响应结束时，服务端会推送一个特殊片段，通常包含 `data: [DONE]`。

示例返回数据：

```JSON
data: {"choices":[{"delta":{"content":"","reasoning_content":"\n","role":"assistant"},"index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
data: {"choices":[{"delta":{"content":"","reasoning_content":"用户","role":"assistant"},"index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
...
data: {"choices":[{"delta":{"content":"","reasoning_content":"。","role":"assistant"},"index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
data: {"choices":[{"delta":{"content":"你","role":"assistant"},"index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
data: {"choices":[{"delta":{"content":"✧","role":"assistant"},"index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
...
data: {"choices":[{"delta":{"content":"","role":"assistant"},"finish_reason":"stop","index":0}],"created":1765713048,"id":"021765713047481dd742fe08f96381a9e3cd447cf1b9ac3192379","model":"doubao-seed-1-6-251015","service_tier":"default","object":"chat.completion.chunk","usage":null}
data: [DONE]
```

处理流程：

- 遍历响应流的每一行（或按缓冲区读取）；
- 过滤空行，提取以 `data:` 开头的行；
- 去除 `data:` 前缀，解析剩余内容（通常为 JSON 字符串）；
- 拼接所有 `data` 字段内容，还原完整响应。

处理示例见[示例代码](#示例代码)。

## 更多示例

- 函数调用流式输出，请参见[Function Calling 流式输出适配](../工具调用/函数调用%20Function%20Calling.md#流式输出适配)。
